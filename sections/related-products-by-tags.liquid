{%- comment -%}
  Related Products Section - Fixed Version
  Shows on product pages only
  Displays products that share at least 2 tags with current product
  Excludes the current product from results
{%- endcomment -%}

{%- comment -%} Alternative: Store product handles instead of IDs {%- endcomment -%}

{% comment %} {%- if template contains 'product' and product -%}
  {%- assign per_row = section.settings.per_row -%}
  {%- assign product_limit = section.settings.product_limit | default: 5 -%}
  {%- assign min_shared_tags = section.settings.min_shared_tags | default: 2 -%}

  {%- assign current_product_tags = product.tags -%}
  {%- assign current_product_id = product.id -%}

  {%- comment -%} Store product handles for later retrieval {%- endcomment -%}
  {%- assign related_handles = '' -%}
  {%- assign related_count = 0 -%}

  {%- for candidate_product in collections.similar.products limit: 100 -%}
    {%- unless candidate_product.id == current_product_id -%}
      {%- assign shared_tags_count = 0 -%}
      {%- for tag in candidate_product.tags -%}
        {%- if current_product_tags contains tag -%}
          {%- assign shared_tags_count = shared_tags_count | plus: 1 -%}
        {%- endif -%}
      {%- endfor -%}

      {%- if shared_tags_count >= min_shared_tags -%}
        {%- if related_handles == '' -%}
          {%- assign related_handles = candidate_product.handle -%}
        {%- else -%}
          {%- assign related_handles = related_handles | append: ',' | append: candidate_product.handle -%}
        {%- endif -%}
        {%- assign related_count = related_count | plus: 1 -%}

        {%- if related_count >= product_limit -%}
          {%- break -%}
        {%- endif -%}
      {%- endif -%}
    {%- endunless -%}
  {%- endfor -%}
{{related_handles | json}}--related_handles****
  {%- assign handle_array = related_handles | split: ',' -%}
{{handle_array | json}}--handle_array
  {%- if handle_array.size > 0 -%}
    {%- if section.settings.divider -%}<div class="section--divider">{%- endif -%}

    <div
      id="RelatedProducts-{{ section.id }}"
      data-section-id="{{ section.id }}"
      data-section-type="related-products-grid"
    >
      {%- if section.settings.title != blank -%}
        <div class="page-width">
          <div class="section-header text-{{ section.settings.heading_alignment }}">
            <h2 class="section-header__title">
              {{ section.settings.title }}
            </h2>
          </div>
        </div>
      {%- endif -%}

      <div class="page-width{% if section.settings.mobile_scrollable %} page-width--flush-small{% endif %}">
        <div
          {% if section.settings.mobile_scrollable %}
            class="grid-overflow-wrapper"
          {% endif %}
        >
          <div
            class="grid grid--uniform"
            {% if section.settings.mobile_scrollable %}
              data-aos="overflow__animation"
            {% endif %}
          >
            {%- liquid
              capture gridView
                render 'products_per_row', products_per_row: per_row, style: 'fractions'
              endcapture

              if section.settings.mobile_scrollable
                assign fallback = '39vw'
              else
                assign fallback = 'variable'
              endif
            -%}

            {%- comment -%} Now we can directly use the product objects {%- endcomment -%}
            {%- for handle in handle_array -%}
              {%- assign related_product = all_products[handle] -%}
              {{related_product | json}}--related_product
              {%- if related_product -%}
                {%- render 'product-grid-item',
                  product: related_product,
                  collection: collections.similar,
                  per_row: per_row,
                  quick_shop_enable: settings.quick_shop_enable,
                  fallback: fallback,
                  gridView: gridView
                -%}
              {%- endif -%}
            {%- endfor -%}
          </div>
        </div>
      </div>
    </div>

    {%- if section.settings.divider -%}</div>{%- endif -%}
  {%- endif -%}
{%- endif -%} {% endcomment %}

{% comment %} ************************************************************************************************************* {% endcomment %}
{%- if template contains 'product' and product -%}
  
  {%- assign per_row = section.settings.per_row -%}
  {%- assign product_limit = section.settings.product_limit | default: 5 -%}
  {%- assign min_shared_tags = section.settings.min_shared_tags | default: 2 -%}
  
  {%- assign current_product_tags = product.tags -%}
  {%- assign current_product_id = product.id -%}
  
  {%- comment -%} First, collect ALL matching products (not limited) {%- endcomment -%}
  {%- assign all_related_handles = '' -%}
  {%- assign all_related_count = 0 -%}
  
  {%- comment -%} Calculate date 2 years ago {%- endcomment -%}
  {%- assign seconds_in_2_years = 63072000 -%}
  {%- assign current_date = 'now' | date: '%s' | plus: 0 -%}
  {%- assign two_years_ago = current_date | minus: seconds_in_2_years -%}
  
  {%- for candidate_product in collections.similar.products limit: 500 -%}
    
    {%- unless candidate_product.id == current_product_id -%}
      
      {%- comment -%} Check if product was created within last 2 years {%- endcomment -%}
      {%- assign product_created_date = candidate_product.created_at | date: '%s' | plus: 0 -%}
      
      {%- if product_created_date > two_years_ago -%}
        
        {%- assign shared_tags_count = 0 -%}
        {%- for tag in candidate_product.tags -%}
          {%- if current_product_tags contains tag -%}
            {%- assign shared_tags_count = shared_tags_count | plus: 1 -%}
          {%- endif -%}
        {%- endfor -%}
        
        {%- if shared_tags_count >= min_shared_tags -%}
          {%- if all_related_handles == '' -%}
            {%- assign all_related_handles = candidate_product.handle -%}
          {%- else -%}
            {%- assign all_related_handles = all_related_handles | append: ',' | append: candidate_product.handle -%}
          {%- endif -%}
          {%- assign all_related_count = all_related_count | plus: 1 -%}
        {%- endif -%}
        
      {%- endif -%}
      
    {%- endunless -%}
  {%- endfor -%}
  
  {%- assign all_handles_array = all_related_handles | split: ',' -%}
  
  {%- if all_handles_array.size > 0 -%}
    
    {%- comment -%} Now apply randomization using timestamp {%- endcomment -%}
    {%- assign timestamp = 'now' | date: '%s' | plus: 0 -%}
    
    {%- comment -%} Create random starting point based on timestamp {%- endcomment -%}
    {%- assign random_start = timestamp | modulo: all_handles_array.size -%}
    
    {%- comment -%} Build array of random products {%- endcomment -%}
    {%- assign random_handles = '' -%}
    {%- assign selected_count = 0 -%}
    
    {%- comment -%} First pass: start from random index to end {%- endcomment -%}
    {%- for i in (0..all_handles_array.size) -%}
      {%- assign current_index = random_start | plus: i | modulo: all_handles_array.size -%}
      
      {%- comment -%} Get handle at current index {%- endcomment -%}
      {%- assign counter = 0 -%}
      {%- for handle in all_handles_array -%}
        {%- if counter == current_index -%}
          {%- if random_handles == '' -%}
            {%- assign random_handles = handle -%}
          {%- else -%}
            {%- assign random_handles = random_handles | append: ',' | append: handle -%}
          {%- endif -%}
          {%- assign selected_count = selected_count | plus: 1 -%}
          {%- break -%}
        {%- endif -%}
        {%- assign counter = counter | plus: 1 -%}
      {%- endfor -%}
      
      {%- if selected_count >= product_limit -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}
    
    {%- assign final_handles = random_handles | split: ',' -%}
    
    {%- comment -%} Display the section {%- endcomment -%}
    {%- if section.settings.divider -%}<div class="section--divider">{%- endif -%}
    
    <div
      id="RelatedProducts-{{ section.id }}"
      data-section-id="{{ section.id }}"
      data-section-type="related-products-grid">
      
      {%- if section.settings.title != blank -%}
        <div class="page-width">
          <div class="section-header text-{{ section.settings.heading_alignment }}">
            <h2 class="section-header__title">
              {{ section.settings.title }}
            </h2>
          </div>
        </div>
      {%- endif -%}
      
      <div class="page-width{% if section.settings.mobile_scrollable %} page-width--flush-small{% endif %}">
        <div{% if section.settings.mobile_scrollable %} class="grid-overflow-wrapper"{% endif %}>
          <div class="grid grid--uniform"{% if section.settings.mobile_scrollable %} data-aos="overflow__animation"{% endif %}>
            
            {%- liquid
              capture gridView
                render 'products_per_row', products_per_row: per_row, style: 'fractions'
              endcapture
              
              if section.settings.mobile_scrollable
                assign fallback = '39vw'
              else
                assign fallback = 'variable'
              endif
            -%}
            
            {%- for handle in final_handles limit: product_limit -%}
              {%- assign related_product = all_products[handle] -%}
              {%- if related_product -%}
                {%- render 'product-grid-item',
                  product: related_product,
                  collection: collections.similar,
                  per_row: per_row,
                  quick_shop_enable: settings.quick_shop_enable,
                  fallback: fallback,
                  gridView: gridView
                -%}
              {%- endif -%}
            {%- endfor -%}
            
          </div>
        </div>
      </div>
    </div>
    
    {%- if section.settings.divider -%}</div>{%- endif -%}
    
  {%- endif -%}
  
{%- endif -%}

{% schema %}
{
  "name": "Related Products",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Heading",
      "default": "You May Also Like"
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "label": "Heading alignment",
      "default": "center",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ]
    },
    {
      "type": "range",
      "id": "per_row",
      "label": "Products per row (desktop)",
      "default": 5,
      "min": 3,
      "max": 6,
      "step": 1
    },
    {
      "type": "range",
      "id": "product_limit",
      "label": "Maximum products to show",
      "default": 5,
      "min": 3,
      "max": 10,
      "step": 1
    },
    {
      "type": "range",
      "id": "min_shared_tags",
      "label": "Minimum shared tags",
      "default": 2,
      "min": 1,
      "max": 10,
      "step": 1,
      "info": "Products must share at least this many tags with the current product"
    },
    {
      "type": "checkbox",
      "id": "mobile_scrollable",
      "label": "Enable horizontal scroll on mobile",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "divider",
      "label": "Show section divider",
      "default": false
    }
  ],
  "presets": [
    {
      "name": "Related Products by Tags",
      "settings": {
        "title": "You May Also Like",
        "per_row": 5,
        "product_limit": 5,
        "min_shared_tags": 2
      }
    }
  ]
}
{% endschema %}
